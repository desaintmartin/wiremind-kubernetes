# v0.0.3
# DO NOT EDIT THIS FILE, CHANGES MAY BE RESET AT ANY MOMENT WITHOUT NOTICE
# Instead, please override values directly in .gitlab-ci.yml
stages:
  - test
  - upload-pypi

variables:
  SRC_DIR: src

image: python:3.5-slim

.test:
  stage: test
  before_script:
    - pip install --extra-index-url https://upload:${PYPIPASSWORD}@pypi.wiremind.fr -r requirements.txt
    - pip install ".[dev]"
  script:
    - cd $SRC_DIR; pwd
    #- python setup.py test  # Cleaner but does not work everywhere
    - nosetests --cover-html --with-coverage --cover-tests --cover-package=$PACKAGE_NAME --cover-inclusive --cover-erase --cover-branches --quiet --cover-html-dir=coverage
  coverage: '/TOTAL.+ ([0-9]{1,3}%)/'
  artifacts:
    paths:
      - $SRC_DIR/coverage
    expire_in: 1 day

test:
  extends: .test

test-python2.7:
  extends: .test
  image: python:2.7-slim

.linting:
  stage: test
  before_script:
    - pip install flake8
  script:
    - flake8 --ignore=F401,E402,E501 $SRC_DIR/$PACKAGE_NAME setup.py

linting:
  extends: .linting

linting-python2.7:
  extends: .linting
  image: python:2.7-slim

safety-check:
  stage: test
  image: python:3.6
  before_script:
    - pip install safety
  script:
    - safety check -r requirements.txt --full-report

mypy:
  stage: test
  before_script:
    - pip install mypy
  script:
    - mypy $SRC_DIR/$PACKAGE_NAME --ignore-missing-imports


upload-python-egg:
  stage: upload-pypi
  image: python:3.5-slim
  before_script:
    - export VERSION=$(cat VERSION)
  script:
    - |
      echo -e "[distutils]
      index-servers = wiremind
      [wiremind]
      repository:https://upload.pypi.wiremind.fr
      username:upload
      password:${PYPIPASSWORD}" > ~/.pypirc
    # Only upload if it is not already on our pypi
    - pip download --extra-index-url https://upload:${PYPIPASSWORD}@pypi.wiremind.fr $PACKAGE_NAME==$VERSION && ALREADY_THERE=true || ALREADY_THERE=false
    - if "$ALREADY_THERE"; then echo "Egg already on index; not uploading."; else
      python setup.py sdist upload -r wiremind;
      fi

